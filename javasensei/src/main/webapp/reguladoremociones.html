<!DOCTYPE html>
<meta charset="UTF-8">

<link href="jquerymobile/jquery.mobile-1.4.4.min.css" rel="stylesheet">
<script type="text/javascript" src="js/jquery-2.1.1.min.js"></script>
<script type="text/javascript" src="jquery-ui-1.11.4.custom/jquery-ui.min.js"></script>
<script type="text/javascript" src="jquerymobile/jquery.mobile-1.4.4.min.js"></script>

<script src="js/webcam.js"></script>

<script>
    $(document).ready(function () {
        Webcam.set({
            dest_width: 610,
            dest_height: 400,
            image_format: 'jpeg',
            jpeg_quality: 75,
            force_flash: false
                    /*flip_horiz: true*/
        });
        Webcam.attach("#cameraregulador");
        
        function tomarFotografia(){
            Webcam.snap(function (dataUrl) {
                
                var imageOriginal = dataUrl;
                var image = dataUrl.replace("data:image/jpeg;base64,", "");
                
                $.ajax({
                    type: "POST",
                    url: "http://javasensei.ddns.net/javasensei/servicios/emociones",
                    data: {fotografia:image},
                    success: function(response){
                        var emocion = response;
                        $("#emocion_text").text(emocion);
                        $("#image_rostro").prop("src", imageOriginal);
                        delete image;
                        delete imageOriginal;
                        
                        /*
                         * Habilitar boton de continuar/cerrar,
                         * desactivar fotografias en caso de estar activado
                         */
                        if (emocion=="Engagment"){
                            clearInterval(temporizador);
                            $("#boton_tomarfoto").button("disable");
                            $( "#check_repetir" ).checkboxradio( "option", "disabled", true );
                            $("#boton_continuar").button("enable");
                        }
                    }
                });

            });
        }
        
        window.temporizador = -1;
        
        $("#slider_intervalos").change(function(){
            if (temporizador != -1){
                clearInterval(temporizador);
                var tiempo = $("#slider_intervalos").val()*1000;
                temporizador = setInterval(tomarFotografia, tiempo);
            }
        });
        
        $("#check_repetir").change(function(){
            //Activar o desactivar
            estado = $("#check_repetir").prop("checked");
            if (estado){
                //Tiempo en milisegundos
                var tiempo = $("#slider_intervalos").val()*1000;
                //Activar temporizador
                temporizador = setInterval(tomarFotografia,tiempo);
                //Desactivar boton de toma de fotografias
                $("#boton_tomarfoto").button("disable");
            }else{
                //Desactivar temporizador
                clearInterval(temporizador);
                temporizador = -1;
                //Activar boton de toma de fotografias
                $("#boton_tomarfoto").button("enable");
            }
        });

        $("#boton_tomarfoto").click(tomarFotografia);

    });
</script>
<style>
    .camera{
        height: 20em !important;
        width: 100% !important;
    }
    .camera video{
        height: 100% !important;
        width: 100% !important;
        transform: none !important;
        transform-origin: center;
    }
    .fotografia{
        height: 20%;
        width: 20%;
    }
</style>

<div data-role="page" data-dialog="true" id="paginacategorizacion" data-close-btn="none">
    <div data-role="header">
        <h2>
            Instrucciones
        </h2>
    </div>
    <div class="ui-content" role="main">
        <p>
            A continuación, el sistema necesitará verificar que te encuentras en un estado emocional optimo, por lo que necesitas tomarte una foto, si la emoción es <b>enganchado</b> te dejará continuar.
        </p>
        <div id="cameraregulador" class="camera"></div>
        <div style="text-align: center;">
            <p>
                <b><span>Emoción: </span><span id="emocion_text"></span></b>
            </p>
            <img class="fotografia" id="image_rostro" src="">
        </div>
        <div class="ui-grid-a">
            <div class="ui-block-a">
                <input id="boton_tomarfoto" type="button" value="Tomar Fotografía">
            </div>
            <div class="ui-block-b">
                <label for="check_repetir">Intervalo automatico</label>
                <input id="check_repetir" name="check_repetir" type="checkbox">
            </div>
        </div>
        <label for="slider_intervalos">Duración de intervalos en segundos:</label>
        <input name="slider_intervalos" id="slider_intervalos" min="2" max="5" value="3" type="range">
        <input type="button" disabled="disabled" id="boton_continuar" value="Continuar">
    </div>
</div>

